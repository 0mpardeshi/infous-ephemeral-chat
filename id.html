<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Second Lock ðŸ”’</title>
<style>
:root {
--bg: #000;
--card: #0f0f10;
--text: #fff;
--muted: #aaa;
--input-bg: #141416;
--input-bd: #2a2b2f;
--btn: #0078ff;
--btn-hover: #005fcc;
--err: #ff4d4d;
--warn: #ffcc00; /* Added for dev mode warning */
}
* { box-sizing: border-box; }
html, body { height: 100%; }
body {
margin: 0;
background: var(--bg);
color: var(--text);
display: grid;
place-items: center;
font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
}
.card {
width: min(92vw, 360px);
background: var(--card);
border: 1px solid #1b1c1f;
border-radius: 16px;
padding: 28px 22px 24px;
box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
h1 {
margin: 0 0 6px;
font-size: 22px;
letter-spacing: .2px;
}
.muted { color: var(--muted); margin: 0 0 16px; font-size: 13px; }
form { display: flex; flex-direction: column; gap: 10px; }
input {
width: 100%;
background: var(--input-bg);
border: 1px solid var(--input-bd);
color: var(--text);
padding: 12px;
border-radius: 10px;
outline: none;
transition: border-color .2s ease;
font-size: 14px;
}
input::placeholder { color: #81828a; }
input:focus { border-color: #3d8bfd; }
button {
background: var(--btn);
color: #fff;
border: none;
border-radius: 10px;
padding: 12px;
font-size: 14px;
cursor: pointer;
transition: background .2s ease, transform .02s ease-in-out;
}
button:hover { background: var(--btn-hover); }
button:active { transform: translateY(1px); }
.err {
color: var(--err);
min-height: 18px;
font-size: 13px;
}
/* New style for dev mode banner */
.dev-mode-banner {
background: var(--warn);
color: #333;
padding: 8px 12px;
border-radius: 8px;
margin-bottom: 15px;
font-size: 12px;
text-align: center;
font-weight: bold;
}
</style>
<script>
// âœ… Guard: Must come from Lock 1
if (sessionStorage.getItem('lock1') !== 'ok') {
localStorage.setItem('__forceLock__', '1');
location.href = 'index.html';
}

// Utility function for SHA-256 hashing
async function sha256(message) {
const msgBuffer = new TextEncoder().encode(message);
const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
const hashArray = Array.from(new Uint8Array(hashBuffer));
const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
return hashHex;
}

// Global config object to store fetched data
let appConfig = {};
let isDevMode = false; // Flag to indicate dev mode
</script>
</head>
<body>
<div class="card">
<div id="devModeBanner" class="dev-mode-banner" style="display: none;">
DEVELOPMENT LOGIN - NOT SECURE
</div>
<h1>Second Lock</h1>
<p class="muted">Info US</p>
<form id="loginForm" autocomplete="off">
<input id="id" placeholder="ID" required />
<input id="pw" type="password" placeholder="Password" required />
<button type="submit">Enter</button>
<div id="err" class="err"></div>
</form>
</div>
<script>
const errEl = document.getElementById('err');
const devModeBanner = document.getElementById('devModeBanner');
let navigatingToHome = false;

async function loadConfig() {
try {
const response = await fetch('/config.json');
if (!response.ok) throw new Error('config.json not found');
appConfig = await response.json();
if (!appConfig.users) throw new Error('Invalid config.json: missing users');
} catch (e) {
console.warn("Failed to load config.json for 'id.html', activating development login mode:", e.message);
isDevMode = true;
devModeBanner.style.display = 'block';
}
}

// Load config before setting up event listener
loadConfig().then(() => {
document.getElementById('loginForm').addEventListener('submit', async (e) => {
e.preventDefault();
const id = document.getElementById('id').value.trim();
const pw = document.getElementById('pw').value;
errEl.textContent = ''; // Clear previous errors

let userValid = false;
let userData = null;

if (isDevMode) {
// Dev mode: any non-empty ID and non-empty password is fine
if (id && pw) {
userValid = true;
// Provide mock user data for dev mode
userData = {
role: "dev",
me: "You (Dev)",
other: "Them (Dev)"
};
// For userId in dev mode, we use the entered ID
sessionStorage.setItem('userId', id);
} else {
errEl.textContent = 'Please enter both ID and Password (Dev Mode)';
}
} else {
// Production mode: validate against hashed passwords from config
const user = appConfig.users[id];
if (!user) {
errEl.textContent = 'Unknown ID';
return;
}

const hashedPw = await sha256(pw);
if (user.passwordHash !== hashedPw) {
errEl.textContent = 'Wrong password';
return;
}
userValid = true;
userData = user;
sessionStorage.setItem('userId', id); // FIX: needed for chat.html keys
}

if (userValid) {
// âœ… Set session keys
sessionStorage.setItem('lock2', 'ok');
sessionStorage.setItem('userRole', userData.role);
sessionStorage.setItem('displayMe', userData.me);
sessionStorage.setItem('displayOther', userData.other);
sessionStorage.setItem('sessionToken', crypto.getRandomValues(new Uint32Array(2)).join('-'));

navigatingToHome = true; // âœ… Avoid vanish when going to home
location.href = 'home.html';
}
});
});


// âœ… Vanish logic (now safe for navigation)
const vanish = () => {
if (!navigatingToHome) {
try { sessionStorage.clear(); } catch (e) {}
localStorage.setItem('__forceLock__', '1');
}
};
addEventListener('beforeunload', vanish);
addEventListener('pagehide', vanish);

// âœ… Disable back/forward
history.pushState(null, null, location.href);
window.onpopstate = function () {
history.go(1);
};
</script>
</body>
</html>
